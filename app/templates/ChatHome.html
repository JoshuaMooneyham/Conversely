{% extends "group_selection.html" %}

{% block content %}
<div id = 'chatroom_head'>
    {% if chatroom.new_group_name != None %}
            <h1>{{chatroom.new_group_name}}</h1>
            <div id='online-count' class='offline'>
                <span id='online_count'>0</span> online
            </div>
            <a href="{% url "invite_users" chatroom.name %}">Invite Users</a>
        {% if current_user == chatroom.admin or current_user in chatroom.moderators.all %}
            <a href="{% url "group_management" chatroom.name %}">Manage</a>
        {% endif %}
    {% else %}
        <h1>{{chatroom.name}}</h1>
        <div id='online-count' class='offline'>
            <span id='online_count'>0</span> online
        </div>
        <a href="{% url "invite_users" chatroom.name %}">Invite Users</a>
        {% if current_user == chatroom.admin or current_user in chatroom.moderators.all %}
        <a href="{% url "group_management" chatroom.name %}">Manage</a>
        {% endif %}
        {% if current_user != chatroom.admin %}
        <a href="{% url "leave_chatroom" chatroom.name%}">Leave Chatroom</a>
        {% endif %}
    {% endif %}

</div>
<div class ='container'>

        <div id='test_wrapper'>
            <div id='messages_container'>
                {% for message in messages %}
                    {% include "message.html" %}
                {% endfor %}
            </div>
            <button id='to-bottom-btn'><i class="fa-solid fa-chevron-down"></i></button>
        </div>
        <div>
            <form id='send-message'
                hx-ext="ws"
                ws-connect="/ws/group/{{channel}}"
                ws-send
                hx-trigger='keydown[code=="Enter" && !shiftKey]'>
                {% csrf_token %}
                {{ form.text }}
            </form>
            <form id="update-message"
                hx-post="{% url "update_message" %}"
                hx-target=""
                hx-trigger='keydown[code=="Enter" && !shiftKey]'
                hx-on::after-request="swapBars(); this.reset()"
                class='hidden'>
                {% csrf_token %}
                {{ form.text }}
                <input type="hidden" id='update_message_id' value='' name='message_id'>
                <input type="hidden" value="{{channel}}" name='channel'>
            </form>
            <form enctype="multipart/form-data"
                hx-post="{% url "chat-file-upload" channel %}"
                hx-target="#messages_container"
                hx-swap="beforeend"
                hx-on::after-request="this.reset()">
                {% csrf_token %}
                <input type="file" name="file">
                <button type="submit">Submit File</button>
            </form>
        </div>
</div>
        <div id='account'></div>
    </div>
    <script>
        addEventListener('htmx:configRequest', (e) => {
            e.detail.headers['X-CSRFToken'] = "{{ csrf_token }}";
        })
    </script>
    <script id='script-testing'></script>

{% endblock content %}